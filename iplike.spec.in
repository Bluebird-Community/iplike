%define rel @RELEASE@
%define version @VERSION@
%define pkgname @PACKAGE@

Name: %{pkgname}
Version: %{version}
Release: %{rel}
License: GPL
Group: Applications/Databases
Summary: PostgreSQL complex IP Address text field query
Source: %{name}-%{version}-%{release}.tar.gz
BuildRoot: %{_tmppath}/%{name}-%{version}-root

BuildRequires: postgresql-devel

%description
PostgreSQL function for doing complex IP address queries
on a text field.

%prep
%setup -n %{name}-%{version}-%{release}

%build
%configure
make

%install
%makeinstall

%post

if [ -z "$SKIP_IPLIKE_INSTALL" ]; then

	FAILED=0

	echo -e "- installing iplike into the template1 db... \c"
	if %{_sbindir}/install_iplike.sh -s postgres -d template1 >/tmp/install_iplike.log 2>&1; then
		echo "OK"
	else
		echo "failed"
		FAILED=1
	fi

	echo -e "- installing iplike into the opennms db (if it exists)... \c"
	if %{_sbindir}/install_iplike.sh -s postgres -d opennms >>/tmp/install_iplike.log 2>&1; then
		echo "OK"
	else
		echo "failed"
		FAILED=1
	fi

	if [ $FAILED -eq 1 ]; then
		cat <<END

Failed to install iplike into the template1 or opennms databases.
See /tmp/install_iplike.log for details.

To skip this step and install manually, set the environment variable
SKIP_IPLIKE_INSTALL before installing this RPM.

To install iplike into your database, use the %{_sbindir}/install_iplike.sh
script.  See \`install_iplike.sh -h\` for more details.

END

		exit 1
	fi

fi

exit 0

%clean
if [ "$RPM_BUILD_ROOT" != "/" ]; then
	rm -rf "$RPM_BUILD_ROOT"
fi

%files
%{_libdir}/iplike*
%attr(755,root,root) %{_sbindir}/install_iplike.sh

%changelog
* Mon Jun 18 2007 Benjamin Reed <ranger@opennms.org> 1.0.1-1
- add RPM build to the autotools stuff
- add postinstall to insert iplike into template1
- many other RPM-related fixes

* Wed Jun 13 2007 Benjamin Reed <ranger@opennms.org> 1.0-1
- initial package
